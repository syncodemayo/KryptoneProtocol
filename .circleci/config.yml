version: 2.1

orbs:
  node: circleci/node@7.1.0

jobs:
  build:
    docker:
      - image: cimg/node:22.15.0
    working_directory: ~/kryptoneprotocol
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: npm install
      - run:
          name: Lint and Test
          command: |
            echo "Running basic validation..."
            node -e "console.log('Node.js is working')"
            npm list --depth=0
      - persist_to_workspace:
          root: .
          paths:
            - api/
            - package.json
            - package-lock.json
            - ecosystem-dev.config.cjs
            - ecosystem-prod.config.cjs
            - .env.example

  deploy-prod:
    docker:
      - image: cimg/base:stable
    working_directory: ~/kryptoneprotocol
    steps:
      - attach_workspace:
          at: .
      - add_ssh_keys:
          fingerprints:
            - "${SSH_KEY_FINGERPRINT}"
      - run:
          name: Adding DigitalOcean Host to Known Hosts
          command: |
            echo "DROPLET_IP=${DROPLET_IP}"
            mkdir -p ~/.ssh
            echo "DROPLET_IP=${DROPLET_IP}"
            ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
      - run:
          name: Deploy to DigitalOcean
          command: |
            ssh root@$DROPLET_IP 'mkdir -p /var/www/kryptoneprotocol-prod'
            
            # Create environment file with production variables
            echo "Creating production environment file..."
            for var in NODE_ENV PORT \
                      ENCRYPTION_KEY_JS JWT_SECRET \
                      ADMIN_MASTER_KEY ADMIN_ADDRESSES \
                      ALCHEMY_RPC_URL USDC_MINT PAYMENT_WALLET_ADDRESS; do

              prefixed_var="PROD_${var}"
              val="${!prefixed_var}"

              if [ -n "$val" ]; then
                echo "${var}=${val}" >> .env
              fi
            done
            
            # Set default production values if not provided
            echo "NODE_ENV=production" >> .env
            echo "PORT=7394" >> .env

            tar -czf deploy.tar.gz api package.json ecosystem-prod.config.cjs .env
            scp deploy.tar.gz root@$DROPLET_IP:/var/www/kryptoneprotocol-prod/

            ssh root@$DROPLET_IP 'cd /var/www/kryptoneprotocol-prod && \
            tar -xzf deploy.tar.gz && \
            rm deploy.tar.gz && \
            
            # Create logs directory
            mkdir -p logs && \
            
            # Ensure Node.js and npm are available
            source ~/.profile && \
            source ~/.bashrc && \
            export NVM_DIR="$HOME/.nvm" && \
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && \
            
            # Install dependencies
            npm install --production && \
            
            # Install PM2 globally if not already installed
            npm install -g pm2 && \
            
            # Stop existing process if running
            pm2 delete kryptoneprotocol-prod || true && \
            
            # Start the application with PM2 using ecosystem file
            pm2 start ecosystem-prod.config.cjs || true \
            pm2 save'

  deploy-dev:
    docker:
      - image: cimg/base:stable
    working_directory: ~/kryptoneprotocol
    steps:
      - attach_workspace:
          at: .
      - add_ssh_keys:
          fingerprints:
            - "${SSH_KEY_FINGERPRINT}"
      - run:
          name: Adding DigitalOcean Host to Known Hosts
          command: |
            echo "DROPLET_IP=${DROPLET_IP}"
            mkdir -p ~/.ssh
            echo "DROPLET_IP=${DROPLET_IP}"
            ssh-keyscan -H $DROPLET_IP >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
      - run:
          name: Deploy to DigitalOcean
          command: |
            ssh root@$DROPLET_IP 'mkdir -p /var/www/kryptoneprotocol-dev'
            
            # Create environment file with development variables
            echo "Creating development environment file..."
            for var in NODE_ENV PORT \
                      ENCRYPTION_KEY_JS JWT_SECRET \
                      ADMIN_MASTER_KEY ADMIN_ADDRESSES \
                      ALCHEMY_RPC_URL USDC_MINT PAYMENT_WALLET_ADDRESS; do

              prefixed_var="DEV_${var}"
              val="${!prefixed_var}"

              if [ -n "$val" ]; then
                echo "${var}=${val}" >> .env
              fi
            done
            
            # Set default development values if not provided
            echo "NODE_ENV=development" >> .env
            echo "PORT=7283" >> .env

            tar -czf deploy.tar.gz api package.json ecosystem-dev.config.cjs .env
            scp deploy.tar.gz root@$DROPLET_IP:/var/www/kryptoneprotocol-dev/

            ssh root@$DROPLET_IP 'cd /var/www/kryptoneprotocol-dev && \
            tar -xzf deploy.tar.gz && \
            rm deploy.tar.gz && \
            
            # Create logs directory
            mkdir -p logs && \
            
            # Ensure Node.js and npm are available
            source ~/.profile && \
            source ~/.bashrc && \
            export NVM_DIR="$HOME/.nvm" && \
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && \
            
            # Install dependencies (including dev dependencies for development)
            npm install && \
            
            # Install PM2 globally if not already installed
            npm install -g pm2 && \
            
            # Stop existing process if running
            pm2 delete kryptoneprotocol-dev || true && \
            
            # Start the application with PM2 using ecosystem file
            pm2 start ecosystem-dev.config.cjs && \
            pm2 save'

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build:
          filters:
            branches:
              only:
                - develop
                - main
      - deploy-dev:
          requires:
            - build
          filters:
            branches:
              only:
                - develop
      - deploy-prod:
          requires:
            - build
          filters:
            branches:
              only: main